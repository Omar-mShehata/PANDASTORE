<!DOCTYPE html>
<html lang="ar" dir="rtl" id="htmlElement">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Buy Telegram Premium - Panda Store</title>
  <link rel="stylesheet" href="/styles.css">
  <link rel="icon" type="image/png" href="/assets/pandastore.jpg">

  <!-- Shared site styles to match buy page navbar -->
  <link href="https://staropay.com/css/reset.css" rel="stylesheet" />
  <link href="https://staropay.com/css/base.css?v=2" rel="stylesheet" />
  <link href="https://staropay.com/css/nav.css" rel="stylesheet" />

  <!-- Axios Library -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <!-- TonConnect Library -->
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
  <!-- SweetAlert2 Library -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="assets/alerts-theme.css" />
    <script defer src="assets/alerts-theme.js"></script>
  <!-- Font Awesome for gear icon -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- TonWeb Library for BOC encoding -->
  <script src="https://unpkg.com/@ton/ton@latest/dist/ton.min.js"></script>

  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(135deg, #1e2a47 0%, #0e1830 100%);
      color: #e6f2ff;
      font-size: 16px;
      margin: 0;
      padding: 0 12px 40px;
      text-align: center;
    }

    .header {
      background: rgba(10, 19, 38, 0.7);
      backdrop-filter: blur(8px);
      color: #e6f2ff;
      padding: 10px 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(0, 163, 255, 0.15);
    }

    .nav {
      display: flex;
      gap: 10px;
    }

    .nav a {
      background: #0f1e36;
      color: #e6f2ff;
      text-decoration: none;
      font-size: 14px;
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid rgba(0, 163, 255, 0.18);
      transition: all .2s ease;
    }

    .nav a:hover {
      background: #0c1a2f;
      color: #fff;
    }

    .wallet-btn {
      font-size: 16px;
      padding: 6px 10px;
      border-radius: 8px;
      color: white;
      border: none;
    }

    .container {
      max-width: 900px;
      margin: 24px auto 0;
      padding: 16px 12px;
      background: transparent;
    }

    .section-title {
      font-size: 28px;
      margin: 12px 0 2px;
      color: #fff;
    }

    .section-sub {
      margin: 0 0 18px;
      color: #9ecbff;
    }

    label {
      display: block;
      margin: 0 0 8px;
      font-weight: 600;
      color: #cfe6ff;
      text-align: start;
    }

    input {
      width: 100%;
      padding: 12px 14px;
      margin-bottom: 18px;
      background: #0f1a2e;
      color: #e6f2ff;
      border: 1px solid rgba(0, 163, 255, 0.2);
      border-radius: 12px;
      outline: none;
      transition: border-color .2s, box-shadow .2s;
    }

    /* Smaller username textbox */
    #username {
      display: block;
      max-width: 360px;
      /* smaller width */
      padding: 12px 16px;
      /* match card horizontal padding */
      margin: 0 auto;
      /* center horizontally */
      font-size: 15px;
      border-radius: 18px;
      /* match card radius */
    }

    input:focus {
      border-color: #34b3ff;
      box-shadow: 0 0 0 3px rgba(0, 163, 255, 0.15);
    }

    .premium-options {
      display: grid;
      gap: 18px;
      grid-template-columns: 1fr;
      margin-top: 24px;
      padding-inline: 18px;
    }

    .premium-option {
      border-radius: 18px;
      padding: 18px 16px 16px;
      background: linear-gradient(180deg, rgba(13, 25, 48, 0.97), rgba(10, 22, 39, 0.97));
      color: #e6f2ff;
      text-align: center;
      border: 1.5px solid rgba(0, 163, 255, 0.18);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
      opacity: 0;
      transform: translateY(18px);
      animation: fadeInUp .5s forwards;
      position: relative;
    }

    .premium-option:nth-child(1) {
      animation-delay: .05s
    }

    .premium-option:nth-child(2) {
      animation-delay: .1s
    }

    .premium-option:nth-child(3) {
      animation-delay: .15s
    }

    .premium-option:hover {
      transform: translateY(-2px);
      box-shadow: 0 16px 50px rgba(0, 0, 0, 0.5), 0 0 20px rgba(0, 163, 255, 0.25);
      border-color: rgba(0, 163, 255, 0.35);
    }

    .premium-option.active {
      box-shadow: 0 18px 60px rgba(0, 0, 0, 0.6), 0 0 28px rgba(52, 179, 255, 0.45);
      border-color: rgba(52, 179, 255, 0.6);
      animation: glowPulse 1.2s ease-in-out infinite alternate;
    }

    @keyframes glowPulse {
      from {
        box-shadow: 0 18px 60px rgba(0, 0, 0, 0.55), 0 0 16px rgba(52, 179, 255, 0.35);
      }

      to {
        box-shadow: 0 22px 70px rgba(0, 0, 0, 0.65), 0 0 32px rgba(52, 179, 255, 0.55);
      }
    }

    .plan-hero {
      display: flex;
      justify-content: center;
      margin-bottom: 10px;
    }

    .plan-hero img {
      width: 90px;
      height: 90px;
      object-fit: contain;
      filter: drop-shadow(0 8px 16px rgba(0, 163, 255, .2));
      background: transparent;
      border-radius: 0;
      border: none;
    }

    .premium-option h3 {
      margin: 4px 0 8px;
      font-size: 20px;
      color: #fff;
    }

    .premium-details {
      display: flex;
      align-items: baseline;
      justify-content: center;
      gap: 8px;
      margin: 6px 0 10px;
    }

    .premium-price {
      font-weight: 800;
      color: #ffd76a;
    }

    .ton-val {
      color: #9ecbff;
      font-size: 14px;
    }

    .benefits {
      list-style: none;
      padding: 0;
      margin: 8px 0 12px;
      color: #d7e9ff;
      text-align: start;
    }

    .benefits li {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      border-radius: 10px;
    }

    .benefits li::before {
      content: "✓";
      color: #8be28b;
      font-weight: 900;
    }

    .actions {
      display: flex;
      gap: 10px;
      margin-top: 8px;
      justify-content: center;
    }

    .btn {
      border: none;
      padding: 10px 18px;
      border-radius: 12px;
      color: #fff;
      font-weight: 700;
      cursor: pointer;
      font-size: 15px;
    }

    .btn-buy {
      background: linear-gradient(90deg, #ff4d77, #ff7a59);
    }

    .btn-buy:active {
      transform: translateY(1px);
    }

    /* Preview modal */
    .preview-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(3, 10, 20, 0.6);
      backdrop-filter: blur(6px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1200;
    }

    .preview-modal {
      width: min(560px, 92vw);
      border-radius: 18px;
      padding: 18px;
      background: linear-gradient(180deg, rgba(13, 25, 48, 0.97), rgba(10, 22, 39, 0.97));
      border: 1px solid rgba(0, 163, 255, .25);
      box-shadow: 0 24px 80px rgba(0, 0, 0, .55), 0 0 30px rgba(0, 163, 255, .25);
      transform: scale(.95);
      opacity: 0;
      transition: .18s ease;
      color: #e6f2ff;
    }

    .preview-backdrop.show {
      display: flex;
    }

    .preview-backdrop.show .preview-modal {
      transform: scale(1);
      opacity: 1;
    }

    .preview-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .preview-title {
      font-size: 20px;
      font-weight: 800;
    }

    .preview-close {
      background: transparent;
      border: none;
      color: #cfe6ff;
      font-size: 22px;
      cursor: pointer;
    }

    .preview-body {
      text-align: center;
    }

    .preview-hero {
      display: flex;
      justify-content: center;
      margin: 6px 0 10px;
    }

    .preview-hero img {
      width: 110px;
      height: 110px;
      object-fit: contain;
    }

    .preview-price {
      font-weight: 800;
      color: #ffd76a;
      font-size: 18px;
      margin-top: 6px;
    }

    .preview-ton {
      color: #9ecbff;
      font-size: 14px;
    }

    .preview-benefits {
      list-style: none;
      padding: 0;
      margin: 10px 0 14px;
      text-align: start;
    }

    .preview-benefits li {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 0;
    }

    .preview-benefits li::before {
      content: "✓";
      color: #8be28b;
      font-weight: 900;
    }

    .preview-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 6px;
    }

    .btn-cancel {
      background: #0f1e36;
      border: 1px solid rgba(0, 163, 255, .3);
    }

    /* Settings */
    .wallet-container {
      display: flex;
      align-items: center;
    }

    .settings-container {
      display: flex;
      justify-content: flex-end;
      padding: 10px 20px;
      position: relative;
    }

    .settings-btn {
      background: #0f1e36;
      color: #e6f2ff;
      font-size: 14px;
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      border: 1px solid rgba(0, 163, 255, .2);
      transition: all .2s;
    }

    .settings-btn:hover {
      background: #0c1a2f;
    }

    .settings-menu {
      position: absolute;
      right: 0;
      top: 100%;
      background: #0f1a2e;
      color: #e6f2ff;
      font-size: 14px;
      border-radius: 12px;
      padding: 8px 0;
      text-align: center;
      display: none;
      min-width: 180px;
      box-shadow: 0 10px 20px rgba(0, 0, 0, .4);
      z-index: 1000;
      border: 1px solid rgba(0, 163, 255, .2);
    }

    .settings-menu.show {
      display: block;
      animation: fadeInDropdown .2s ease;
    }

    .settings-menu-item {
      padding: 10px 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .settings-menu-item:hover {
      background: #0c1a2f;
    }

    .settings-menu-item i {
      width: 20px;
      text-align: center;
    }

    @keyframes fadeInUp {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeInDropdown {
      from {
        opacity: 0;
        transform: translateY(-8px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    #buy-btn {
      display: none;
    }

    @media (min-width: 720px) {
      .premium-options {
        grid-template-columns: 1fr 1fr 1fr;
      }
    }

    /* Minimal helpers for buy-like mobile menu */
    .mobile-menu-container {
      display: none;
      position: fixed;
      top: 0;
      right: 0;
      width: 80%;
      max-width: 300px;
      height: 100%;
      background-color: #030e17;
      z-index: 1000;
      overflow-y: auto;
      box-shadow: -2px 0 10px rgba(0, 0, 0, .5);
    }

    .mobile-menu-header {
      padding: 20px;
      display: flex;
      justify-content: flex-end;
    }

    .mobile-menu-body {
      padding: 20px;
    }

    .mobile-menu-ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .mobile-menu-li {
      margin-bottom: 15px;
    }

    .mobile-menu-a {
      color: #fff;
      text-decoration: none;
      font-size: 18px;
      display: block;
      padding: 10px;
      border-radius: 5px;
    }

    .mobile-menu-a:hover {
      background-color: #031724;
    }

    .mobile-wallet-btn {
      background: #031724;
      color: #fff;
      border: none;
      padding: 12px;
      width: 100%;
      border-radius: 15px;
      font-size: 16px;
      margin-bottom: 20px;
      cursor: pointer;
    }

    .burger-btn {
      display: none;
      cursor: pointer;
    }

    @media (max-width: 768px) {
      .navbar-wrapper {
        display: none;
      }

      .burger-btn {
        display: block;
      }
    }

    @media (min-width: 769px) {
      .burger-btn {
        display: none;
      }

      .mobile-menu-container {
        display: none !important;
      }
    }

    /* Force burger on the right, logo on the left on mobile */
    .navbar {
      direction: ltr !important;
      display: flex;
      align-items: center;
      position: relative;
    }

    .navbar .burger-btn {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      margin-left: 0;
    }

    .navbar .logo-wrapper {
      margin-right: 0;
    }
  </style>
</head>

<body>
  <nav class="navbar">
    <div class="logo-wrapper">
      <a class="navbar-brand" href="/index.html">
        <img alt="Panda Store" src="/assets/pandastore.jpg" />
        <h1>Panda Store</h1>
      </a>
    </div>
    <div class="navbar-wrapper">
      <div class="navbar-sub-wrapper">
        <ul class="navbar-items-wrapper">
          <li class="item-default"><a class="item item-a" href="/index.html" id="home-link">Home</a></li>
          <li class="item-default"><a class="item item-a" href="/buy.html" id="stars-link">Stars</a></li>
          <li class="item-default"><a class="item item-a" href="/premium.html" id="premium-link">Premium</a></li>
          <li class="item-default"><a class="item item-a" href="https://t.me/OMAR_M_SHEHATA" target="_blank"
              id="support-link">Support</a></li>
          <li class="item-default"><a class="item item-a" href="https://t.me/PandaStoreShop" target="_blank"
              id="channel-link">TG Channel</a></li>
        </ul>
      </div>
      <div class="navbar-sub-wrapper navbar-profiler" style="gap:8px">
        <button class="wallet-btn" style="background:#0f1e36;border:1px solid rgba(0,163,255,.25)"
          onclick="toggleLanguage()" id="language-switcher">AR / EN</button>
      </div>
    </div>
    <div class="burger-btn" id="burger_btn" aria-label="menu">
      <svg fill="none" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg" width="28" height="28">
        <path d="M3 7C3 6.448 3.448 6 4 6H24C24.552 6 25 6.448 25 7C25 7.552 24.552 8 24 8H4C3.448 8 3 7.552 3 7Z"
          fill="#ffffff" />
        <path
          d="M3 14C3 13.448 3.448 13 4 13H24C24.552 13 25 13.448 25 14C25 14.552 24.552 15 24 15H4C3.448 15 3 14.552 3 14Z"
          fill="#ffffff" />
        <path
          d="M4 20C3.448 20 3 20.448 3 21C3 21.552 3.448 22 4 22H24C24.552 22 25 21.552 25 21C25 20.448 24.552 20 24 20H4Z"
          fill="#ffffff" />
      </svg>
    </div>
  </nav>

  <!-- Mobile Menu -->
  <div class="mobile-menu-container" id="mobile_menu_container">
    <div class="mobile-menu-header">
      <div class="mobile-menu-cross" id="mobile_menu_cross">
        <svg fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="24" height="24">
          <path d="M19 5L5 19M5.00001 5L19 19" stroke="#ffffff" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round"></path>
        </svg>
      </div>
    </div>
    <div class="mobile-menu-body">
      <div id="ton-connect-btn-mobile" class="mobile-wallet-btn">Connect Wallet : <br><br></div>
      <button class="mobile-wallet-btn" onclick="toggleLanguage()">AR / EN</button>
      <ul class="mobile-menu-ul">
        <li class="mobile-menu-li"><a class="mobile-menu-a" href="/index.html" id="home-link-mobile">Home</a></li>
        <li class="mobile-menu-li"><a class="mobile-menu-a" href="/buy.html" id="stars-link-mobile">Stars</a></li>
        <li class="mobile-menu-li"><a class="mobile-menu-a" href="/premium.html" id="premium-link-mobile">Premium</a>
        </li>
        <li class="mobile-menu-li"><a class="mobile-menu-a" href="https://t.me/OMAR_M_SHEHATA" target="_blank"
            id="support-link-mobile">Support</a></li>
        <li class="mobile-menu-li"><a class="mobile-menu-a" href="https://t.me/PandaStoreShop" target="_blank"
            id="channel-link-mobile">TG Channel</a></li>
      </ul>
    </div>
  </div>

  <h1 class="section-title" id="main-title">اشترِ تليجرام بريميوم</h1><br>
  <p class="section-sub" id="sub-title">اشترك لنفسك أو لأصدقائك</p>

  <div class="container">
    <label id="username-label">Telegram username</label>
    <input type="text" placeholder="@username" id="username" required /><br>
    <label id="plan-label">اختر خطة الاشتراك:</label>
    <div class="premium-options">
      <div class="premium-option">
        <div class="plan-hero"><img src="/assets/3month.png" alt="3 أشهر" /></div>
        <h3 id="plan-3-title">3 أشهر</h3>
        <div class="premium-details">
          <span id="plan-3-price" class="premium-price">$13.00</span>
          <span id="plan-3-ton" class="ton-val"></span>
        </div>
        <ul id="plan-3-features" class="benefits"></ul>
        <div class="actions">
          <button class="btn btn-buy" onclick="buyNow(3,13)">شراء الآن</button>
        </div>
      </div>
      <div class="premium-option">
        <div class="plan-hero"><img src="/assets/6month.png" alt="6 أشهر" /></div>
        <h3 id="plan-6-title">6 أشهر</h3>
        <div class="premium-details">
          <span id="plan-6-price" class="premium-price">$17.00</span>
          <span id="plan-6-ton" class="ton-val"></span>
        </div>
        <ul id="plan-6-features" class="benefits"></ul>
        <div class="actions">
          <button class="btn btn-buy" onclick="buyNow(6,17)">شراء الآن</button>
        </div>
      </div>
      <div class="premium-option">
        <div class="plan-hero"><img src="/assets/12month.png" alt="12 شهر" /></div>
        <h3 id="plan-12-title">12 شهر</h3>
        <div class="premium-details">
          <span id="plan-12-price" class="premium-price">$30.00</span>
          <span id="plan-12-ton" class="ton-val"></span>
        </div>
        <ul id="plan-12-features" class="benefits"></ul>
        <div class="actions">
          <button class="btn btn-buy" onclick="buyNow(12,30)">شراء الآن</button>
        </div>
      </div>
    </div>

    <button class="buy-btn" id="buy-btn" onclick="submitOrder()">اشترك الآن</button>
  </div>

  <!-- Preview Modal -->
  <div id="preview_backdrop" class="preview-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="preview-modal" role="document">
      <div class="preview-header">
        <div class="preview-title" id="preview_title">Premium</div>
        <button class="preview-close" id="preview_close" aria-label="Close">×</button>
      </div>
      <div class="preview-body">
        <div class="preview-hero"><img id="preview_img" src="" alt="" /></div>
        <div class="preview-ton" id="preview_ton"></div>
        <div class="preview-price" id="preview_price"></div>
        <ul class="preview-benefits" id="preview_benefits"></ul>
        <div class="preview-actions">
          <button class="btn btn-cancel" id="preview_cancel">Cancel</button>
          <button class="btn btn-buy" id="preview_confirm">Buy Now</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Initialize TonConnect (mobile button only, like buy page)
    const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
      manifestUrl: 'https://pandastores.netlify.app/tonconnect-manifest.json',
      buttonRootId: 'ton-connect-btn-mobile'
    });

    const MERCHANT_ADDRESS = "UQAcDae1BvWVAD0TkhnGgDme4b7NH9Fz8JXce-78TW6ekmvN";
    let currentTonUsd = null;
    let selectedPlan = null;
    let selectedPrice = null;
    let isEnglish = true; // Default to Arabic

    // Complete translations
    const translations = {
      title: {
        ar: "اشترِ تيليجرام بريميوم",
        en: "Buy Telegram Premium"
      },
      subtitle: {
        ar: "اشترك لنفسك أو لأصدقائك",
        en: "Subscribe for yourself or friends"
      },
      usernameLabel: {
        ar: "اسم المستخدم على تليجرام",
        en: "Telegram username"
      },
      usernamePlaceholder: {
        ar: "@username",
        en: "@username"
      },
      planLabel: {
        ar: "اختر خطة الاشتراك:",
        en: "Choose a subscription plan:"
      },
      plans: {
        ar: {
          "3": "3 شهور",
          "6": "6 شهور",
          "12": "12 شهر"
        },
        en: {
          "3": "3 Months",
          "6": "6 Months",
          "12": "12 Months"
        }
      },
      prices: {
        ar: {
          "3": "13 دولار",
          "6": "17 دولار",
          "12": "30 دولار"
        },
        en: {
          "3": "$13.00",
          "6": "$17.00",
          "12": "$30.00"
        }
      },
      tonPrice: {
        ar: "≈ %ton% TON",
        en: "≈ %ton% TON"
      },
      subscribeNow: {
        ar: "اشترك الآن",
        en: "Subscribe Now"
      },
      home: {
        ar: "الرئيسية",
        en: "Home"
      },
      stars: {
        ar: "النجوم",
        en: "Stars"
      },
      premium: {
        ar: "بريميوم",
        en: "Premium"
      },
      switchLanguage: {
        ar: "English",
        en: "اللغة العربية"
      },
      settings: {
        ar: "الإعدادات",
        en: "Settings"
      },
      features: {
        ar: {
          "3": ["شارة Premium", "تحميل أسرع", "تحويل الصوت إلى نص", "حدود أعلى للقنوات"],
          "6": ["شارة Premium", "تحميل أسرع", "تحويل الصوت إلى نص", "صور بروفايل متحركة"],
          "12": ["جميع مميزات Premium", "مساحة تخزين أكبر", "ملصقات حصرية", "أولوية في الدعم"]
        },
        en: {
          "3": ["Premium badge", "Faster downloads", "Voice to text", "Higher channel limits"],
          "6": ["Premium badge", "Faster downloads", "Voice to text", "Animated profile photos"],
          "12": ["All Premium features", "More storage", "Exclusive stickers", "Priority support"]
        }
      }
    };

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function () {
      // Burger/mobile menu wiring
      const burgerBtn = document.getElementById('burger_btn');
      const mobileMenu = document.getElementById('mobile_menu_container');
      const closeBtn = document.getElementById('mobile_menu_cross');
      if (burgerBtn && mobileMenu && closeBtn) {
        burgerBtn.addEventListener('click', function () {
          mobileMenu.style.display = 'block';
          document.body.style.overflow = 'hidden';
        });
        closeBtn.addEventListener('click', function () {
          mobileMenu.style.display = 'none';
          document.body.style.overflow = '';
        });
      }

      // Fetch TON price and update plan prices
      fetchTonPrice();
    });

    async function fetchTonPrice() {
      const isLocal = location.hostname === '127.0.0.1' || location.hostname === 'localhost';
      try {
        const res = await axios.get("https://api.coingecko.com/api/v3/simple/price?ids=the-open-network&vs_currencies=usd", { timeout: 5000 });
        currentTonUsd = res.data["the-open-network"].usd;
      } catch (e) {
        console.warn("Failed to fetch TON price for preview", e && e.message);
        if (isLocal && !currentTonUsd) {
          currentTonUsd = 5.0; // local fallback USD price per TON
          if (window.notify) notify.toast(isEnglish ? 'Using fallback TON price (local).' : 'استخدام سعر TON افتراضي (محلي).', 'info');
        }
      }

      updatePlanPrices();
      // Initialize all text elements
      updateAllText();
    }

    async function checkWalletBalance(requiredTon) {
      try {
        const walletConnection = tonConnectUI.wallet;
        if (!walletConnection) {
          return {
            success: false,
            message: isEnglish ?
              'Please connect your wallet first 🛡️' :
              'يرجى ربط المحفظة أولاً 🛡️'
          };
        }

        const response = await axios.get(`https://toncenter.com/api/v2/getAddressBalance?address=${walletConnection.account.address}`);
        const availableBalance = parseFloat(response.data.result) / 1e9;

        if (availableBalance < requiredTon) {
          return {
            success: false,
            message: isEnglish ?
              `Your balance (${availableBalance.toFixed(2)} TON) is insufficient. You need ${requiredTon.toFixed(2)} TON.` :
              `رصيدك (${availableBalance.toFixed(2)} TON) غير كافٍ. تحتاج ${requiredTon.toFixed(2)} TON.`
          };
        }

        return { success: true };
      } catch (error) {
        console.error('Balance check error:', error);
        return {
          success: false,
          message: isEnglish ?
            'Failed to check wallet balance. Please try again.' :
            'فشل التحقق من رصيد المحفظة. يرجى المحاولة مرة أخرى.'
        };
      }
    }

    async function encodeComment(comment) {
      try {
        // Create new cell
        const cell = new TonWeb.boc.Cell();

        // Write 32-bit zero (op=0 for simple comments)
        cell.bits.writeUint(0, 32);

        // Write comment as UTF-8
        cell.bits.writeString(comment);

        // Convert cell to BOC (Bag of Cells)
        const boc = await TonWeb.boc.Cell.toBoc(cell);

        // Convert BOC to base64
        return btoa(String.fromCharCode.apply(null, new Uint8Array(boc)));
      } catch (e) {
        console.error('Failed to encode comment:', e);
        return ''; // Return empty payload if encoding fails
      }
    }

    function updatePlanPrices() {
      if (!currentTonUsd) return;

      const plans = [3, 6, 12];
      plans.forEach(plan => {
        const price = getPlanPrice(plan);
        const tonAmount = (price / currentTonUsd).toFixed(5);
        const element = document.getElementById(`plan-${plan}-ton`);
        if (element) {
          element.textContent = translations.tonPrice[isEnglish ? 'en' : 'ar'].replace('%ton%', tonAmount);
        }
      });
    }

    function getPlanPrice(months) {
      switch (months) {
        case 3: return 13;
        case 6: return 17;
        case 12: return 30;
        default: return 0;
      }
    }

    function toggleLanguage() {
      isEnglish = !isEnglish;
      const htmlElement = document.getElementById('htmlElement');
      const languageBtn = document.getElementById('language-switcher');

      // Change page direction and language
      htmlElement.dir = isEnglish ? 'ltr' : 'rtl';
      htmlElement.lang = isEnglish ? 'en' : 'ar';

      // Update all text elements
      updateAllText();
    }

    function updateAllText() {
      // Update language switcher text (if present)
      const langBtn = document.getElementById('language-switcher');
      if (langBtn) {
        if (langBtn.tagName.toLowerCase() === 'button') {
          langBtn.textContent = translations.switchLanguage[isEnglish ? 'en' : 'ar'];
        } else {
          const span = langBtn.querySelector('span');
          if (span) span.textContent = translations.switchLanguage[isEnglish ? 'en' : 'ar'];
        }
      }

      // Update main titles
      document.getElementById('main-title').textContent = translations.title[isEnglish ? 'en' : 'ar'];
      document.getElementById('sub-title').textContent = translations.subtitle[isEnglish ? 'en' : 'ar'];

      // Update form labels
      document.getElementById('username-label').textContent = translations.usernameLabel[isEnglish ? 'en' : 'ar'];
      document.getElementById('username').placeholder = translations.usernamePlaceholder[isEnglish ? 'en' : 'ar'];
      document.getElementById('plan-label').textContent = translations.planLabel[isEnglish ? 'en' : 'ar'];

      // Update buttons
      document.getElementById('buy-btn').textContent = translations.subscribeNow[isEnglish ? 'en' : 'ar'];

      // Update navigation links (desktop)
      document.getElementById('home-link').textContent = translations.home[isEnglish ? 'en' : 'ar'];
      document.getElementById('stars-link').textContent = translations.stars[isEnglish ? 'en' : 'ar'];
      document.getElementById('premium-link').textContent = translations.premium[isEnglish ? 'en' : 'ar'];
      // Update navigation links (mobile if present)
      const homeM = document.getElementById('home-link-mobile'); if (homeM) homeM.textContent = translations.home[isEnglish ? 'en' : 'ar'];
      const starsM = document.getElementById('stars-link-mobile'); if (starsM) starsM.textContent = translations.stars[isEnglish ? 'en' : 'ar'];
      const premiumM = document.getElementById('premium-link-mobile'); if (premiumM) premiumM.textContent = translations.premium[isEnglish ? 'en' : 'ar'];

      // Update plan titles and prices
      const plans = [3, 6, 12];
      plans.forEach(plan => {
        const titleElement = document.getElementById(`plan-${plan}-title`);
        const priceElement = document.getElementById(`plan-${plan}-price`);

        if (titleElement) {
          titleElement.textContent = translations.plans[isEnglish ? 'en' : 'ar'][plan];
        }
        if (priceElement) {
          priceElement.textContent = translations.prices[isEnglish ? 'en' : 'ar'][plan];
        }
      });

      // Update features lists
      const feats = translations.features[isEnglish ? 'en' : 'ar'];
      [3, 6, 12].forEach(m => {
        const ul = document.getElementById(`plan-${m}-features`);
        if (ul) {
          ul.innerHTML = '';
          feats[m].forEach(text => {
            const li = document.createElement('li');
            li.textContent = text;
            ul.appendChild(li);
          });
        }
      });
      // Update per-card buy buttons text
      document.querySelectorAll('.btn-buy').forEach(btn => {
        btn.textContent = isEnglish ? 'Buy Now' : 'شراء الآن';
      });
      // Update TON prices
      updatePlanPrices();
    }

    function selectPlan(months, price) {
      selectedPlan = months;
      selectedPrice = price;
      // Highlight selected plan visually
      const cards = document.querySelectorAll('.premium-option');
      cards.forEach(c => c.style.outline = 'none');
      const idx = { 3: 0, 6: 1, 12: 2 }[months];
      if (typeof idx !== 'undefined' && cards[idx]) {
        cards[idx].style.outline = '2.5px solid #34b3ff';
      }
    }

    function buyNow(months, price) {
      selectPlan(months, price);
      openPreview(months, price);
    }

    function openPreview(months, price) {
      const backdrop = document.getElementById('preview_backdrop');
      const title = document.getElementById('preview_title');
      const img = document.getElementById('preview_img');
      const ton = document.getElementById('preview_ton');
      const usd = document.getElementById('preview_price');
      const benefits = document.getElementById('preview_benefits');

      // Title
      title.textContent = isEnglish ? translations.plans.en[String(months)] : translations.plans.ar[String(months)];
      // Image
      const imgMap = { 3: '/assets/3month.png', 6: '/assets/6month.png', 12: '/assets/12month.png' };
      img.src = imgMap[months] || '';
      img.alt = title.textContent;
      // Prices
      const priceText = isEnglish ? translations.prices.en[String(months)] : translations.prices.ar[String(months)];
      usd.textContent = priceText;
      if (currentTonUsd) {
        const tonAmount = (price / currentTonUsd).toFixed(5);
        ton.textContent = (isEnglish ? '≈ ' : '≈ ') + tonAmount + ' TON';
      } else {
        ton.textContent = '';
      }
      // Benefits
      const feats = translations.features[isEnglish ? 'en' : 'ar'][String(months)] || [];
      benefits.innerHTML = '';
      feats.forEach(t => { const li = document.createElement('li'); li.textContent = t; benefits.appendChild(li); });

      backdrop.classList.add('show');
      document.body.style.overflow = 'hidden';

      // Highlight active card
      const idx = { 3: 0, 6: 1, 12: 2 }[months];
      const cards = document.querySelectorAll('.premium-option');
      cards.forEach(c => c.classList.remove('active'));
      if (typeof idx !== 'undefined' && cards[idx]) cards[idx].classList.add('active');

      // Wire buttons
      const close = document.getElementById('preview_close');
      const cancel = document.getElementById('preview_cancel');
      const confirm = document.getElementById('preview_confirm');
      // Localize buttons
      cancel.textContent = isEnglish ? 'Cancel' : 'إلغاء';
      confirm.textContent = isEnglish ? 'Buy Now' : 'شراء الآن';
      const closeFn = () => { backdrop.classList.remove('show'); document.body.style.overflow = ''; cards.forEach(c => c.classList.remove('active')); };
      close.onclick = cancel.onclick = closeFn;
      confirm.onclick = () => { closeFn(); submitOrder(); };
    }

    async function submitOrder() {
      const username = document.getElementById("username").value.trim().replace(/^@/, '');

  if (!username) { notify.toast(isEnglish ? 'Enter Telegram username. ✏️' : 'أدخل اسم مستخدم تليجرام. ✏️','error'); return; }

  if (!selectedPlan) { notify.toast(isEnglish ? 'Please select a subscription plan. ✏️' : 'الرجاء اختيار خطة اشتراك. ✏️','error'); return; }

      const amountUSD = selectedPrice;

      let tonUsd = currentTonUsd;
      if (!tonUsd) {
        try {
          const r = await axios.get("https://api.coingecko.com/api/v3/simple/price?ids=the-open-network&vs_currencies=usd", { timeout: 5000 });
          tonUsd = r.data["the-open-network"].usd;
        } catch (e) {
          const isLocal = location.hostname === '127.0.0.1' || location.hostname === 'localhost';
          if (isLocal) {
            tonUsd = 5.0; // local fallback
            notify.toast(isEnglish ? 'Using fallback TON price (local).' : 'استخدام سعر TON افتراضي (محلي).', 'info');
          } else {
            notify.toast(isEnglish ? 'Failed to get TON price, try later. 🌐' : 'لم يتم جلب سعر TON، حاول لاحقًا. 🌐','error');
            return;
          }
        }
      }

      const requiredTon = amountUSD / tonUsd;

      // Check wallet balance first
      const balanceCheck = await checkWalletBalance(requiredTon);
  if (!balanceCheck.success) { notify.toast(balanceCheck.message || (isEnglish ? 'Insufficient Balance 💰' : 'رصيد غير كافٍ 💰'),'error'); return; }

      const tonAmountN = BigInt(Math.ceil(requiredTon * 1e9));
      const refNumber = 'PS' + Math.random().toString(36).substring(2, 9).toUpperCase();

      // Send without payload/comment to improve compatibility with wallets
      const tx = {
        validUntil: Math.floor(Date.now() / 1000) + 300,
        messages: [{
          address: MERCHANT_ADDRESS,
          amount: tonAmountN.toString()
        }]
      };

      try {
        const connectedWallet = tonConnectUI.wallet;
        if (!connectedWallet) { notify.toast(isEnglish ? 'Connect your wallet first 🛡️' : 'اربط محفظتك أولاً 🛡️','warning'); return; }

        const result = await tonConnectUI.sendTransaction(tx);

        // Show persistent processing modal with localized text
        const processingTitle = isEnglish ? 'Processing your order ⏳' : 'جاري معالجة الطلب ⏳';
        const processingText = isEnglish ? 'Please do not leave the page until your order is completed.' : 'من فضلك لا تغادر الصفحة قبل إتمام طلبك.';
        notify.loading(processingTitle, processingText);

        setTimeout(async () => {
          try {
            await axios.post("https://pandastore-f2yn.onrender.com/premium", {
              username,
              months: selectedPlan,
              amountTon: (requiredTon).toFixed(5),
              amountUsd: amountUSD.toFixed(2),
              refNumber: refNumber
            });
            notify.close();
            const msg = isEnglish ? `Premium for ${selectedPlan} months will be activated for @${username} within 5-10 minutes.` : `سيتم تفعيل بريميوم لمدة ${selectedPlan} أشهر لـ @${username} خلال 5-10 دقائق.`;
            notify.success(isEnglish ? 'Order received ✅' : 'تم استلام الطلب ✅', msg);
          } catch (err) {
            // Even if backend logging fails, inform success to user (as before)
            notify.close();
            const msg = isEnglish ? `Premium for ${selectedPlan} months will be activated for @${username} within 5-10 minutes.` : `سيتم تفعيل بريميوم لمدة ${selectedPlan} أشهر لـ @${username} خلال 5-10 دقائق.`;
            notify.success(isEnglish ? 'Order received ✅' : 'تم استلام الطلب ✅', msg);
          }
        }, 2000);

      } catch (error) {
        console.error('Transaction error:', error);

        let errorMessage = isEnglish ? 'Please try again.' : 'حاول مرة أخرى.';
        if (error.message.includes('Insufficient balance')) {
          errorMessage = isEnglish ?
            'Your wallet does not have enough TON to complete this transaction.' :
            'محفظتك لا تحتوي على رصيد كافٍ من TON لإتمام هذه العملية.';
        }

  notify.close();
  notify.toast(errorMessage || (isEnglish ? 'Transaction failed ❌' : 'فشلت المعاملة ❌'),'error');
      }
    }
  </script>
</body>

</html>