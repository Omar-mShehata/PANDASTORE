<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ملفي الشخصي | Panda Store</title>
  <link rel="stylesheet" href="assets/alerts-theme.css" />
  <link rel="icon" href="assets/pandastore.jpg" type="image/x-icon" />
  <style>
    body {background: linear-gradient(180deg,#0b1020,#0a1326); color: #fff; font-family: 'Cairo', Arial, sans-serif; margin: 0;}
    .profile-container {max-width: 520px; margin: 40px auto 0; background: linear-gradient(180deg,rgba(13,25,48,.96),rgba(10,22,39,.96)); border-radius: 22px; border:1px solid rgba(0,163,255,.18); box-shadow: 0 10px 30px rgba(0,0,0,.35); padding: 32px 24px 24px; text-align: center;}
    .profile-avatar {width: 110px; height: 110px; border-radius: 50%; border: 4px solid #FFD951; margin-bottom: 18px; object-fit: cover; background: #fff;}
    .profile-name {font-size: 1.5rem; color: #FFD951; margin-bottom: 6px;}
    .profile-username {color: #b3c6e0; font-size: 1.1rem; margin-bottom: 18px;}
    .invite-section {background: #122647; border-radius: 14px; padding: 18px 10px; margin: 18px 0 0; border:1px solid rgba(0,163,255,.18)}
    .invite-title {color: #FFD951; font-size: 1.1rem; margin-bottom: 8px;}
    .invite-link {background: #fff; color: #031724; border-radius: 8px; padding: 8px 10px; font-size: 0.98rem; word-break: break-all; display: inline-block; margin-bottom: 8px;}
    .copy-btn {background: linear-gradient(90deg,#34b3ff,#00a3ff); color: #fff; border: none; border-radius: 8px; padding: 9px 18px; font-size: 1rem; cursor: pointer; margin-bottom: 10px; transition: background 0.2s;}
    .copy-btn:hover {background: #FFD951; color: #031724;}
    .invite-stats {color: #e6f2ff; font-size: 1.05rem; margin-top: 10px;}
    .earnings {color: #FFD951; font-size: 1.2rem; margin-top: 8px;}
    @media (max-width: 600px) {.profile-container {padding: 18px 4vw;}}
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
</head>
<body>
  <div class="profile-container">
    <div style="display:flex;justify-content:flex-end;margin-bottom:8px">
      <button id="back-btn" class="copy-btn" style="background:#0f1e36;border:1px solid rgba(0,163,255,.25);">رجوع</button>
    </div>
  <img id="avatar" class="profile-avatar" src="assets/pandaemogi.jpg" alt="Avatar" />
  <div class="profile-name" id="name">اسم المستخدم</div>
  <div class="profile-username" id="username">@username</div>

  <div class="invite-section">
    <div class="invite-title">رابط الدعوة الخاص بك</div>
    <div class="invite-link" id="invite-link">جارٍ التحميل...</div>

    <!-- زر نسخ الرابط -->
    <button class="copy-btn" onclick="copyInvite()">نسخ الرابط</button>

  <!-- زر TON Connect (نفس مكون باقي الصفحات) -->
  <div id="ton-connect-btn" style="display:inline-block;margin-left:8px;"></div>

    <!-- عرض عنوان المحفظة المرتبطة -->
    <div id="wallet-address" style="margin-top:10px;color:#b3c6e0;font-size:0.95rem;"></div>

  <div class="invite-stats">عدد الأشخاص المدعوين: <span id="ref-count">0</span></div>
  <div class="earnings">أرباحك من الدعوات: <span id="ref-earn">0.00</span> $</div>
  <div class="invite-stats">صافى ربحك بالنجوم: <span id="net-stars">0</span> ⭐</div>
  <button class="copy-btn" id="withdraw-btn" style="margin-top:12px;background:linear-gradient(90deg,#ff7b7b,#ff4b4b)">سحب الأرباح</button>
    </div>

    <script>
    // استخدام زر TonConnect الرسمي كما في باقي الصفحات
    (function initTonConnectUI(){
      const walletAddressEl = document.getElementById('wallet-address');
      const inviteEl = document.getElementById('invite-link');
      // إنشاء مثيل واحد عالمي لإعادة استخدامه في الأسفل
      window.tcu = new TON_CONNECT_UI.TonConnectUI({
      manifestUrl: 'https://pandastores.netlify.app/tonconnect-manifest.json',
        buttonRootId: 'ton-connect-btn'
      });

      function applyAddress(addr){
        if (addr) {
          walletAddressEl.textContent = 'محفظة مرتبطة: ' + addr;
          inviteEl.textContent = `${location.origin}/buy.html?ref=${encodeURIComponent(addr)}`;
          try{ localStorage.setItem('wallet', addr); }catch{}
        } else {
          walletAddressEl.textContent = '';
          const fallback = localStorage.getItem('wallet');
          inviteEl.textContent = fallback ? `${location.origin}/buy.html?ref=${encodeURIComponent(fallback)}` : 'جارٍ التحميل...';
        }
      }

      const setFromSession = (session)=> applyAddress(session?.account?.address || null);
      // عند التحميل
      window.tcu.getWallet().then(setFromSession).catch(()=>applyAddress(localStorage.getItem('wallet')));
      // عند تغير الحالة
      window.tcu.onStatusChange(setFromSession);
    })();
    </script>
  </div>
  <script>
    // زر رجوع: يغلق الويب فيو داخل تيليجرام أو يعود صفحة للخلف بالمتصفح
    (function(){
      const back=document.getElementById('back-btn');
      if(!back) return;
      back.addEventListener('click', ()=>{
        try{ if(window.Telegram && Telegram.WebApp){ Telegram.WebApp.close(); return; } }catch{}
        history.length > 1 ? history.back() : (location.href = 'index.html');
      });
    })();

    // تهيئة Telegram WebApp وتحميل بيانات المستخدم
    function loadTelegramProfile() {
      try {
        if (window.Telegram && Telegram.WebApp) {
          Telegram.WebApp.ready();
          const user = Telegram.WebApp.initDataUnsafe?.user;
          if (user) {
            document.getElementById('name').textContent = user.first_name + (user.last_name ? ' ' + user.last_name : '');
            document.getElementById('username').textContent = user.username ? '@' + user.username : `ID: ${user.id}`;
            if (user.photo_url) document.getElementById('avatar').src = user.photo_url;
          }
        }

        // قراءة ref من الاستعلام إن وجد وحفظه كمحفظة افتراضية للزائر
        const params = new URLSearchParams(location.search);
        const ref = params.get('ref');
        if (ref) localStorage.setItem('referrer_wallet', ref);

        // استخدام نفس مثيل TonConnect UI لتوليد رابط الإحالة
        const setInvite = (session) => {
          const addr = session?.account?.address || localStorage.getItem('wallet');
          const el = document.getElementById('invite-link');
          if (addr) {
            const invite = `${location.origin}/buy.html?ref=${encodeURIComponent(addr)}`;
            el.textContent = invite;
            try { localStorage.setItem('wallet', addr); } catch {}
          } else {
            el.textContent = 'وصّل محفظتك لتوليد رابط الإحالة تلقائيًا.';
          }
        };
        if (window.tcu && typeof window.tcu.getWallet === 'function') {
          window.tcu.getWallet().then(setInvite).catch(()=>{
            setInvite(null);
          });
          if (typeof window.tcu.onStatusChange === 'function') window.tcu.onStatusChange(setInvite);
        } else {
          // Fallback على المخزن المحلي
          setInvite(null);
        }
      } catch (e) {
        console.warn('Telegram WebApp init failed', e);
      }
    }
    loadTelegramProfile();
    // زر نسخ رابط الدعوة
    async function copyInvite() {
      const el = document.getElementById('invite-link');
      const link = (el.textContent||'').trim();
      if (!/^https?:\/\//i.test(link)) {
        try{ if(window.tcu && typeof window.tcu.openModal==='function'){ await window.tcu.openModal(); return; } }catch{}
        alert('من فضلك وصّل محفظتك أولًا لتوليد رابط الإحالة.');
        return;
      }
      try {
        await navigator.clipboard.writeText(link);
        alert('تم نسخ رابط الدعوة!');
      } catch {
        const ta = document.createElement('textarea');
        ta.value = link; document.body.appendChild(ta); ta.select();
        try { document.execCommand('copy'); alert('تم نسخ رابط الدعوة!'); } finally { document.body.removeChild(ta); }
      }
    }
    // نظام إحصائيات الدعوات (توضيح فقط)
    // في التطبيق الحقيقي يجب جلب البيانات من قاعدة بيانات
    function loadReferralStats() {
      // محاولة جلب ملخص الإحالات من السيرفر
      const myWallet = localStorage.getItem('wallet') || 'WALLET_ADDRESS';
      fetch(`/affiliate/summary?wallet=${encodeURIComponent(myWallet)}`)
        .then(r => r.ok ? r.json() : Promise.reject())
        .then(data => {
          document.getElementById('ref-count').textContent = data.total_orders ?? 0;
          document.getElementById('ref-earn').textContent = Number(data.total_usd || 0).toFixed(4);
          const netStars = (Number(data.total_usd || 0) / 0.0157) || 0;
          document.getElementById('net-stars').textContent = Math.floor(netStars);
          window.__affiliateSummary = { usd: Number(data.total_usd||0), stars: Number(data.total_stars||0) };
        })
        .catch(() => {
          // رجوع إلى حساب محلي بسيط
          const count = localStorage.getItem('refCount') || 0;
          const starsSoldByRefs = localStorage.getItem('refSoldStars') || 0;
          const commissionPerStar = 0.0157 - 0.015;
          const myShare = 0.10 * commissionPerStar * parseInt(starsSoldByRefs, 10);
          document.getElementById('ref-count').textContent = count;
          document.getElementById('ref-earn').textContent = myShare.toFixed(4);
          const netStars = (myShare / 0.0157) || 0;
          document.getElementById('net-stars').textContent = Math.floor(netStars);
          window.__affiliateSummary = { usd: myShare, stars: Number(starsSoldByRefs)||0 };
        });
    }
    loadReferralStats();

    // زر سحب الأرباح: يرسل طلب برسالة إلى الأدمن داخل تيليجرام
    (function(){
      const btn = document.getElementById('withdraw-btn');
      if(!btn) return;
      btn.addEventListener('click', async ()=>{
        const addr = localStorage.getItem('wallet') || (window.tcu && (await window.tcu.getWallet())?.account?.address) || '';
        const sum = window.__affiliateSummary || { usd: 0, stars: 0 };
        const tgUser = (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe?.user) || null;
        try{
          const resp = await fetch('/affiliate/withdraw', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ wallet: addr, usd: Number(sum.usd||0), stars: Number(sum.stars||0), tg: tgUser })
          });
          if (resp.ok) {
            alert('تم إرسال طلب السحب إلى الإدارة. سنراجع الطلب ونتواصل معك.');
          } else {
            const text = encodeURIComponent(`طلب سحب أرباح\nالمحفظة: ${addr||'غير متوفر'}\nإجمالي الأرباح: ${Number(sum.usd||0).toFixed(4)}$\nصافى بالنجوم: ${Math.floor((Number(sum.usd||0)/0.0157)||0)}⭐`);
            const shareUrl = `https://t.me/share/url?url=&text=${text}`;
            if(window.Telegram && Telegram.WebApp && typeof Telegram.WebApp.openTelegramLink==='function'){
              Telegram.WebApp.openTelegramLink(shareUrl);
            } else {
              window.open(shareUrl, '_blank');
            }
          }
        } catch (e) {
          const text = encodeURIComponent(`طلب سحب أرباح\nالمحفظة: ${addr||'غير متوفر'}\nإجمالي الأرباح: ${Number(sum.usd||0).toFixed(4)}$\nصافى بالنجوم: ${Math.floor((Number(sum.usd||0)/0.0157)||0)}⭐`);
          const shareUrl = `https://t.me/share/url?url=&text=${text}`;
          if(window.Telegram && Telegram.WebApp && typeof Telegram.WebApp.openTelegramLink==='function'){
            Telegram.WebApp.openTelegramLink(shareUrl);
          } else {
            window.open(shareUrl, '_blank');
          }
        }
      });
    })();
  </script>
  <footer style="text-align:center;color:#b3c6e0;padding:30px 0 10px;font-size:0.95rem;">جميع الحقوق محفوظة © Panda Store 2025</footer>
</body>
</html>
